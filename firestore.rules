rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================
    // Helpers
    // =========================
    function isAuthenticated() {
      return request.auth != null;
    }

    function role() {
      return isAuthenticated() && 'role' in request.auth.token ? request.auth.token.role : null;
    }

    function isAdmin() {
      return role() == 'admin';
    }

    function isNpoStaff() {
      return role() == 'npo-staff';
    }

    function isAmbassador() {
      return role() == 'ambassador';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function npoId() {
      return isAuthenticated() && 'npoId' in request.auth.token ? request.auth.token.npoId : null;
    }

    // For "system-only" writes (Cloud Functions / server)
    // You must set a custom claim like { system: true } on the service account user if you use Auth,
    // OR use the Admin SDK (bypasses rules entirely).
    function isSystem() {
      return isAuthenticated() && request.auth.token.system == true;
    }

    // Prevent changing specific fields on update
    // Check if resource exists before accessing resource.data
    function unchanged(keys) {
      return resource.data != null && 
             request.resource.data.diff(resource.data).changedKeys().hasAny(keys) == false;
    }


    // ============================================
    // MEMBERS COLLECTION
    // ============================================
    match /members/{userId} {
      // All authenticated users can read member information (including list operations)
      // Owner and admin always have access
      allow read: if isAuthenticated();

      // Only create own doc
      allow create: if isOwner(userId);

      // Owner can update own "safe" fields only (block privilege/points tampering)
      // Admin can update anything
      // NPO staff can update members that belong to their org, but still block sensitive fields
      allow update: if isAuthenticated() && (
        isAdmin() ||

        (isOwner(userId) && unchanged([
          "role", "npoId", "member_level", "member_credit", "member_xp",
          "teamId", "countryId", "member_status"
        ])) ||

        (isNpoStaff() && resource.data.npoId == npoId() && unchanged([
          "role", "npoId", "member_level", "member_credit", "member_xp"
        ]))
      );

      // Only admins can delete profiles
      allow delete: if isAdmin();

      // ============================================
      // MEMBER SUBCOLLECTIONS
      // ============================================

      // Applications subcollection
      match /applications/{applicationId} {
        // All authenticated users can read applications
        allow read: if isAuthenticated();

        // Only owner can create an application under their member doc
        allow create: if isOwner(userId) &&
          request.resource.data.userId == request.auth.uid;

        // Owner can update their app but not impersonate/change critical fields
        // Admin and NPO staff can update applications for their organization
        allow update: if isAuthenticated() && (
          isAdmin() ||
          (isOwner(userId) &&
            resource.data.userId == request.auth.uid &&
            request.resource.data.userId == request.auth.uid &&
            unchanged(["userId", "organizationId", "activityId", "createdAt"])
          ) ||
          (isNpoStaff() && resource.data.organizationId == request.auth.token.npoId) ||
          (isAmbassador() && resource.data.organizationId == request.auth.token.npoId)
        );

        // Only admins can delete applications
        allow delete: if isAdmin();
      }

      // History subcollection (activity history)
      match /history/{historyId} {
        // Read: All authenticated users can read history
        allow read: if isAuthenticated();

        // Create: System-only (normally via Admin SDK which bypasses rules)
        allow create: if isSystem();

        // Update/Delete: Only admins
        allow update, delete: if isAdmin();
      }

      // XP History subcollection
      match /xpHistory/{xpHistoryId} {
        // Read: Only owner and admins can read XP history
        allow read: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin()
        );

        // Create: Owner can create their own XP history entries, system/admin can create any
        // Note: Frontend calls logXpHistory which creates entries in user's own history
        allow create: if isAuthenticated() && (
          isOwner(userId) ||
          isAdmin() ||
          isSystem()
        );

        // Update/Delete: Only admins
        allow update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // ACTIVITIES COLLECTION
    // ============================================
    match /activities/{activityId} {
      // Read: Authenticated users can read activities
      // Public activities (status == 'Open') are readable by all authenticated users
      // Draft activities are only readable by admins and NPO staff of the organization
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.status == 'Open' ||
        resource.data.status == 'Closed' ||
        (isNpoStaff() && resource.data.organizationId == request.auth.token.npoId) ||
        (isAmbassador() && resource.data.organizationId == request.auth.token.npoId)
      );
      
      // Create: Admins and NPO staff can create activities for their organization
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isNpoStaff() && request.resource.data.organizationId == request.auth.token.npoId) ||
        (isAmbassador() && request.resource.data.organizationId == request.auth.token.npoId)
      );
      
      // Update: Admins and NPO staff can update activities for their organization
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isNpoStaff() && resource.data.organizationId == request.auth.token.npoId) ||
        (isAmbassador() && resource.data.organizationId == request.auth.token.npoId)
      );
      
      // Delete: Only admins can delete activities
      allow delete: if isAdmin();
      
      // ============================================
      // ACTIVITY SUBCOLLECTIONS
      // ============================================
      
      // Applications subcollection
      match /applications/{applicationId} {
        // Read: All authenticated users can read applications (including list operations)
        // Individual document access can be further restricted if needed
        allow read: if isAuthenticated();
        
        // Create: Authenticated users can create applications
        allow create: if isAuthenticated() && 
          request.resource.data.userId == request.auth.uid;
        
        // Update: Owner can update their own applications (e.g., cancel)
        // Admins and NPO staff can update applications for their organization's activities
        allow update: if isAuthenticated() && (
          isAdmin() ||
          (resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid) ||
          (isNpoStaff() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId) ||
          (isAmbassador() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId)
        );
        
        // Delete: Only admins can delete applications
        allow delete: if isAdmin();
      }
      
      // Validations subcollection
      match /validations/{validationId} {
        // Read: All authenticated users can read validations (including list operations)
        allow read: if isAuthenticated();
        
        // Create: Authenticated users can create validations (QR code validation)
        // NPO staff can create validations for their organization's activities
        allow create: if isAuthenticated() && (
          request.resource.data.userId == request.auth.uid ||
          (isNpoStaff() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId) ||
          (isAmbassador() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId)
        );
        
        // Update: NPO staff can update validations for their organization's activities
        // Admins can update any validation
        allow update: if isAuthenticated() && (
          isAdmin() ||
          (isNpoStaff() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId) ||
          (isAmbassador() && get(/databases/$(database)/documents/activities/$(activityId)).data.organizationId == request.auth.token.npoId)
        );
        
        // Delete: Only admins can delete validations
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // ORGANIZATIONS COLLECTION
    // ============================================
    match /organizations/{organizationId} {
      // Read: Authenticated users can read organizations
      allow read: if isAuthenticated();
      
      // Create: Only admins can create organizations
      allow create: if isAdmin();
      
      // Update: Admins and NPO staff can update their own organization
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isNpoStaff() && request.auth.token.npoId == organizationId) ||
        (isAmbassador() && request.auth.token.npoId == organizationId)
      );
      
      // Delete: Only admins can delete organizations
      allow delete: if isAdmin();
      
      // Applications subcollection
      match /applications/{applicationId} {
        // Read: Admins and NPO staff can read applications for their organization
        allow read: if isAuthenticated() && (
          isAdmin() ||
          (isNpoStaff() && organizationId == request.auth.token.npoId) ||
          (isAmbassador() && organizationId == request.auth.token.npoId) ||
          (resource.data.userId == request.auth.uid)
        );
        
        // Create: System creates these (mirror of activity applications)
        // Allow authenticated users for backward compatibility
        allow create: if isAuthenticated();
        
        // Update: Admins and NPO staff can update applications for their organization
        allow update: if isAuthenticated() && (
          isAdmin() ||
          (isNpoStaff() && organizationId == request.auth.token.npoId) ||
          (isAmbassador() && organizationId == request.auth.token.npoId)
        );
        
        // Delete: Only admins
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // BADGES COLLECTION
    // ============================================
    match /badges/{categoryId} {
      // Read: All authenticated users can read badge categories
      allow read: if isAuthenticated();
      
      // Create/Update/Delete: Only admins can manage badge categories
      allow create, update, delete: if isAdmin();
      
      // Badges subcollection
      match /badges/{badgeId} {
        // Read: All authenticated users can read badges
        allow read: if isAuthenticated();
        
        // Create/Update/Delete: Only admins can manage badges
        allow create, update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Read: Users can read their own notifications, admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
      
      // Create: System creates notifications (cloud functions)
      // Allow authenticated users for backward compatibility
      allow create: if isAuthenticated();
      
      // Update: Users can update their own notifications (mark as read), admins can update any
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
      
      // Delete: Users can delete their own notifications, admins can delete any
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // FAQ COLLECTION
    // ============================================
    match /faq/{faqId} {
      // Read: All authenticated users can read FAQs
      allow read: if isAuthenticated();
      
      // Create/Update/Delete: Only admins can manage FAQs
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // IDEA BOX COLLECTION
    // ============================================
    match /ideaBox/{ideaId} {
      // Read: Only admins can read idea box submissions
      allow read: if isAdmin();
      
      // Create: Authenticated users can submit ideas
      allow create: if isAuthenticated();
      
      // Update/Delete: Only admins can manage ideas
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // SKILLS COLLECTION
    // ============================================
    match /skills/{skillId} {
      // Read: All authenticated users can read skills
      allow read: if isAuthenticated();
      
      // Create/Update/Delete: Only admins can manage skills
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // SKILL CATEGORIES COLLECTION
    // ============================================
    match /skillCategories/{categoryId} {
      // Read: All authenticated users can read skill categories
      allow read: if isAuthenticated();
      
      // Create/Update/Delete: Only admins can manage skill categories
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // REWARD ERRORS COLLECTION (Cloud Functions Only)
    // ============================================
    match /rewardErrors/{errorId} {
      // Read/Write: Only admins and cloud functions (server-side)
      // For client-side, deny all access
      allow read, write: if false;
    }
  }
}
