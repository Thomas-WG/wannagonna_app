rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================
    // Helpers
    // =========================
    function isAuthenticated() {
      return request.auth != null;
    }

    function role() {
      return isAuthenticated() && 'role' in request.auth.token ? request.auth.token.role : null;
    }

    function isAdmin() {
      return role() == 'admin';
    }

    function isNpoStaff() {
      return role() == 'npo-staff';
    }

    function isAmbassador() {
      return role() == 'ambassador';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function npoId() {
      return isAuthenticated() && 'npoId' in request.auth.token ? request.auth.token.npoId : null;
    }

    // For "system-only" writes (Cloud Functions / server)
    // You must set a custom claim like { system: true } on the service account user if you use Auth,
    // OR use the Admin SDK (bypasses rules entirely).
    function isSystem() {
      return isAuthenticated() && request.auth.token.system == true;
    }

    // Prevent changing specific fields on update
    // Check if resource exists before accessing resource.data
    function unchanged(keys) {
      return resource.data != null && 
             request.resource.data.diff(resource.data).changedKeys().hasAny(keys) == false;
    }


    // ============================================
    // MEMBERS COLLECTION
    // ============================================
    match /members/{userId} {
      // Read: Open for code search (unauthenticated users need to validate referral codes)
      // Authenticated users can read all member information
      allow read: if true;

      // Create: Open for account creation (users don't exist yet)
      // Allow authenticated users to create their own document, or unauthenticated for account creation
      allow create: if request.auth == null || 
                       (isAuthenticated() && request.resource.data.userId == request.auth.uid);

      // Update: Any authenticated user can update any member document
      allow update: if isAuthenticated();

      // Delete: Only admins can delete profiles
      allow delete: if isAdmin();

      // ============================================
      // MEMBER SUBCOLLECTIONS
      // ============================================

      // Applications subcollection
      match /applications/{applicationId} {
        // All authenticated users can read applications
        allow read: if isAuthenticated();

        // Any authenticated user can create applications
        allow create: if isAuthenticated();

        // Any authenticated user can update applications
        allow update: if isAuthenticated();

        // Only admins can delete applications
        allow delete: if isAdmin();
      }

      // History subcollection (activity history)
      match /history/{historyId} {
        // Read: All authenticated users can read history
        allow read: if isAuthenticated();

        // Create: Any authenticated user can create history entries
        allow create: if isAuthenticated();

        // Update/Delete: Only admins
        allow update, delete: if isAdmin();
      }

      // XP History subcollection
      match /xpHistory/{xpHistoryId} {
        // Read: All authenticated users can read XP history
        allow read: if isAuthenticated();

        // Create: Any authenticated user can create XP history entries
        allow create: if isAuthenticated();

        // Update/Delete: Only admins
        allow update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // ACTIVITIES COLLECTION
    // ============================================
    match /activities/{activityId} {
      // Read: All authenticated users can read activities
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user can create activities
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user can update activities
      allow update: if isAuthenticated();
      
      // Delete: Only admins can delete activities
      allow delete: if isAdmin();
      
      // ============================================
      // ACTIVITY SUBCOLLECTIONS
      // ============================================
      
      // Applications subcollection
      match /applications/{applicationId} {
        // Read: All authenticated users can read applications
        allow read: if isAuthenticated();
        
        // Create: Any authenticated user can create applications
        allow create: if isAuthenticated();
        
        // Update: Any authenticated user can update applications
        allow update: if isAuthenticated();
        
        // Delete: Only admins can delete applications
        allow delete: if isAdmin();
      }
      
      // Validations subcollection
      match /validations/{validationId} {
        // Read: All authenticated users can read validations
        allow read: if isAuthenticated();
        
        // Create: Any authenticated user can create validations
        allow create: if isAuthenticated();
        
        // Update: Any authenticated user can update validations
        allow update: if isAuthenticated();
        
        // Delete: Only admins can delete validations
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // ORGANIZATIONS COLLECTION
    // ============================================
    match /organizations/{organizationId} {
      // Read: All authenticated users can read organizations
      allow read: if isAuthenticated();
      
      // Create: Only admins can create organizations
      allow create: if isAdmin();
      
      // Update: Any authenticated user can update organizations
      allow update: if isAuthenticated();
      
      // Delete: Only admins can delete organizations
      allow delete: if isAdmin();
      
      // Applications subcollection
      match /applications/{applicationId} {
        // Read: All authenticated users can read applications
        allow read: if isAuthenticated();
        
        // Create: Any authenticated user can create applications
        allow create: if isAuthenticated();
        
        // Update: Any authenticated user can update applications
        allow update: if isAuthenticated();
        
        // Delete: Only admins can delete applications
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // BADGES COLLECTION
    // ============================================
    match /badges/{categoryId} {
      // Read: All authenticated users can read badge categories
      allow read: if isAuthenticated();
      
      // Create/Update: Any authenticated user can manage badge categories
      allow create, update: if isAuthenticated();
      
      // Delete: Only admins can delete badge categories
      allow delete: if isAdmin();
      
      // Badges subcollection
      match /badges/{badgeId} {
        // Read: All authenticated users can read badges
        allow read: if isAuthenticated();
        
        // Create/Update: Any authenticated user can manage badges
        allow create, update: if isAuthenticated();
        
        // Delete: Only admins can delete badges
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Read: All authenticated users can read notifications
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user can create notifications
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user can update notifications
      allow update: if isAuthenticated();
      
      // Delete: Any authenticated user can delete notifications
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // FAQ COLLECTION
    // ============================================
    match /faq/{faqId} {
      // Read: All authenticated users can read FAQs
      allow read: if isAuthenticated();
      
      // Create/Update: Any authenticated user can manage FAQs
      allow create, update: if isAuthenticated();
      
      // Delete: Only admins can delete FAQs
      allow delete: if isAdmin();
    }
    
    // ============================================
    // IDEA BOX COLLECTION
    // ============================================
    match /ideaBox/{ideaId} {
      // Read: All authenticated users can read idea box submissions
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user can submit ideas
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user can update ideas
      allow update: if isAuthenticated();
      
      // Delete: Only admins can delete ideas
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SKILLS COLLECTION
    // ============================================
    match /skills/{skillId} {
      // Read: All authenticated users can read skills
      allow read: if isAuthenticated();
      
      // Create/Update: Any authenticated user can manage skills
      allow create, update: if isAuthenticated();
      
      // Delete: Only admins can delete skills
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SKILL CATEGORIES COLLECTION
    // ============================================
    match /skillCategories/{categoryId} {
      // Read: All authenticated users can read skill categories
      allow read: if isAuthenticated();
      
      // Create/Update: Any authenticated user can manage skill categories
      allow create, update: if isAuthenticated();
      
      // Delete: Only admins can delete skill categories
      allow delete: if isAdmin();
    }
    
    // ============================================
    // REWARD ERRORS COLLECTION (Cloud Functions Only)
    // ============================================
    match /rewardErrors/{errorId} {
      // Read/Write: Only admins and cloud functions (server-side)
      // For client-side, deny all access
      allow read, write: if false;
    }
  }
}
